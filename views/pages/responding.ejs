<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head'); %>
        <link rel="stylesheet"
            href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
        <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

        <style>
            #missionMap {
                height: 450px;
                width: 100%;
            }
        </style>
</head>

<body>
    <%- include('../partials/page-start'); %>
    <div class="container-fluid position-relative d-flex p-0">
        <!-- Spinner Start -->
        <%- include('../partials/spinner'); %>
            <!-- Spinner End -->

            <!-- Sidebar Start -->
            <%- include('../partials/responder-sidebar'); %>
                <!-- Sidebar End -->

                <!-- Content Start -->
                <div class="content">
                    <!-- Navbar Start -->
                    <%- include('../partials/responder-navbar'); %>
                        <!-- Navbar End -->

                        <!-- Active Mission Section -->
                        <div class="container-fluid pt-4 px-4">
                            <div class="mission-card rounded p-4 h-100">
                                <div class="d-flex align-items-center justify-content-between mb-4">
                                    <h4 class="text-warning mb-0"><i class="fa fa-ambulance me-2"></i>ACTIVE RESPONSE:
                                        <%= mission.disaster_type.toUpperCase() %>
                                    </h4>
                                    <div class="text-end">
                                        <span class="badge bg-warning text-dark mb-1">STATUS: RESPONDING</span><br>
                                        <small class="text-muted">
                                            <%= new Date(mission.reported_at).toLocaleString() %>
                                        </small>
                                    </div>
                                </div>

                                <!-- Resolution / Status Actions -->
                                <div
                                    class="alert alert-dark border-warning d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-white mb-0">Action Required:</h6>
                                        <small>Go to the incident location. Once resolved, click the button.</small>
                                    </div>

                                    <div id="resolve-btn-container">
                                        <% if (!mission.user_confirmed_at) { %>
                                            <button class="btn btn-secondary" disabled>
                                                <i class="fa fa-hourglass-half me-2"></i>Waiting for User Report...
                                            </button>
                                            <% } else { %>
                                                <button onclick="resolveMission(<%= mission.incident_id %>)"
                                                    class="btn btn-success fw-bold">
                                                    <i class="fa fa-check-circle me-2"></i>MARK AS RESOLVED
                                                </button>
                                                <% } %>
                                    </div>
                                </div>

                                <div class="row g-4">
                                    <!-- Mission Details -->
                                    <div class="col-md-4">
                                        <div class="bg-secondary rounded p-3 h-100">
                                            <h6 class="text-white border-bottom pb-2">Reporter Details</h6>
                                            <p class="mb-1 text-white"><strong>Name:</strong>
                                                <%= mission.firstname %>
                                                    <%= mission.lastname %>
                                            </p>
                                            <p class="mb-1 text-white"><strong>Contact:</strong>
                                                <%= mission.contact_number %>
                                            </p>
                                            <hr>
                                            <h6 class="text-white border-bottom pb-2">Location</h6>
                                            <p class="mb-0 text-white small" id="incident-addr">Loading address...</p>
                                            <p class="text-muted small">
                                                <%= mission.incident_lat %>, <%= mission.incident_lng %>
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Live Map -->
                                    <div class="col-md-8">
                                        <div id="missionMap"></div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Other Nearby Disasters (Read Only) -->
                        <div class="container-fluid pt-4 px-4">
                            <div class="bg-secondary text-center rounded p-4">
                                <div class="d-flex align-items-center justify-content-between mb-4">
                                    <h6 class="mb-0 text-white">Other Nearby Disasters</h6>
                                </div>
                                <div class="table-responsive">
                                    <table class="table text-start align-middle table-bordered table-hover mb-0">
                                        <thead>
                                            <tr class="text-white">
                                                <th scope="col">Date & Time</th>
                                                <th scope="col">Type</th>
                                                <th scope="col">Address</th>
                                                <th scope="col">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (reports.length> 0) { %>
                                                <% reports.forEach(function(report) { %>
                                                    <tr>
                                                        <td>
                                                            <%= new Date(report.reported_at).toLocaleString() %>
                                                        </td>
                                                        <td>
                                                            <%= report.disaster_type %>
                                                        </td>
                                                        <td class="addr-load" data-lat="<%= report.latitude %>"
                                                            data-lon="<%= report.longitude %>">Loading...</td>
                                                        <td>
                                                            <%= report.status %>
                                                        </td>
                                                    </tr>
                                                    <% }); %>
                                                        <% } else { %>
                                                            <tr>
                                                                <td colspan="4">No other active reports nearby.</td>
                                                            </tr>
                                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Start -->
                        <%- include('../partials/page-end'); %>
                        <%- include('../partials/footer'); %>
                            <!-- Footer End -->
                </div>
                <!-- Content End -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // 1. Mission Map Logic
        // Safe Injection
        const incidentLat = <% - mission.incident_lat || 'null' %>;
        const incidentLng = <% - mission.incident_lng || 'null' %>;

        if (incidentLat !== null && incidentLng !== null) {
            const map = L.map('missionMap').setView([incidentLat, incidentLng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Incident Marker
            const fireIcon = L.icon({
                iconUrl: '/images/fire-icon.png', // Fallback or use standard if missing
                iconSize: [40, 40]
            });
            L.marker([incidentLat, incidentLng]).addTo(map)
                .bindPopup("<b>INCIDENT LOCATION</b><br><%= mission.disaster_type %>").openPopup();

            // Reverse Geocode Incident Address
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${incidentLat}&lon=${incidentLng}`)
                .then(res => res.json())
                .then(data => {
                    const addrEl = document.getElementById('incident-addr');
                    if (addrEl) addrEl.innerText = data.display_name || "Address not found";
                });

            // User/Responder Location Tracking & Routing
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    const myLat = pos.coords.latitude;
                    const myLng = pos.coords.longitude;

                    // Update Server
                    fetch('/api/responder/location', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lat: myLat, lng: myLng })
                    });

                    // Routing Control
                    if (!window.routingControl) {
                        window.routingControl = L.Routing.control({
                            waypoints: [
                                L.latLng(myLat, myLng),
                                L.latLng(incidentLat, incidentLng)
                            ],
                            lineOptions: { styles: [{ color: '#00cc00', opacity: 0.8, weight: 6 }] },
                            createMarker: function (i, wp) {
                                if (i === 0) return L.marker(wp.latLng).bindPopup("<b>You</b>");
                                return null; // Don't replace incident marker
                            },
                            addWaypoints: false,
                            draggableWaypoints: false,
                            fitSelectedRoutes: true,
                            show: false // Hide text instructions to save space
                        }).addTo(map);
                    } else {
                        window.routingControl.setWaypoints([
                            L.latLng(myLat, myLng),
                            L.latLng(incidentLat, incidentLng)
                        ]);
                    }

                }, err => console.error(err), { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 });
            }
        } else {
            document.getElementById('missionMap').innerHTML = '<div class="d-flex align-items-center justify-content-center h-100"><p class="text-danger">Invalid Incident Coordinates</p></div>';
        }

        // 2. Resolve Logic
        function resolveMission(id) {
            Swal.fire({
                title: 'Resolve Incident?',
                text: "Are you sure this incident is resolved? The user will also need to confirm.",
                icon: 'question',
                input: 'textarea',
                inputPlaceholder: 'Enter resolution remarks...',
                showCancelButton: true,
                confirmButtonColor: '#198754',
                confirmButtonText: 'Yes, Resolve'
            }).then((result) => {
                if (result.isConfirmed) {
                    const remarks = result.value || "Resolved by responder";
                    fetch('/api/resolve', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ incidentId: id, remarks: remarks })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Success', 'Status updated. Waiting for user confirmation.', 'success')
                                    .then(() => location.reload());
                            } else {
                                Swal.fire('Error', 'Failed to update status', 'error');
                            }
                        });
                }
            })
        }

        // 3. Load Addresses for Nearby Table
        document.querySelectorAll('.addr-load').forEach(td => {
            const lat = td.getAttribute('data-lat');
            const lon = td.getAttribute('data-lon');
            if (lat && lon) {
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                    .then(res => res.json())
                    .then(data => {
                        td.innerText = data.display_name || "Unknown Address";
                    });
            }
        });

        // 4. Real-time Status Polling
        setInterval(() => {
            fetch('/api/my-current-mission')
                .then(res => res.json())
                .then(mission => {
                    if (!mission || !mission.id) {
                        // Mission ended or resolved fully
                        window.location.href = '/responder-history'; // or dashboard
                        return;
                    }

                    // Update Resolve Button State
                    const container = document.getElementById('resolve-btn-container');
                    if (container) {
                        const currentBtn = container.querySelector('button');
                        // Check if we need to Enable
                        if (mission.user_confirmed_at) {
                            if (currentBtn.disabled) {
                                container.innerHTML = `
                                <button onclick="resolveMission(${mission.incident_id})" class="btn btn-success fw-bold">
                                    <i class="fa fa-check-circle me-2"></i>MARK AS RESOLVED
                                </button>
                            `;
                            }
                        } else {
                            // Check if we need to Disable
                            if (!currentBtn.disabled) {
                                container.innerHTML = `
                                <button class="btn btn-secondary" disabled>
                                    <i class="fa fa-hourglass-half me-2"></i>Waiting for User Report...
                                </button>
                            `;
                            }
                        }
                    }
                })
                .catch(err => console.error("Polling error:", err));
        }, 2000);
    </script>
</body>

</html>