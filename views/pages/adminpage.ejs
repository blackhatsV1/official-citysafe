<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head'); %>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>
        <link rel="stylesheet"
            href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
        <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
</head>

<body class="bg-dark text-white">
    <%- include('../partials/page-start'); %>
    <div class="container-fluid position-relative d-flex p-0">
        <%- include('../partials/spinner'); %>
            <%- include('../partials/admin-sidebar', { currentPage: 'dashboard' }); %>

                <div class="content">
                    <%- include('../partials/admin-navbar', { currentPage: 'dashboard' }); %>

                        <!-- Main Dashboard -->
                        <div class="container-fluid pt-4 px-4 pb-4">
                            <!-- System Pulse -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div
                                        class="card p-4 border-0 shadow-sm d-flex flex-row align-items-center justify-content-between">
                                        <div>
                                            <h4 class="mb-1 fw-800 text-head">OPERATIONS COMMAND</h4>
                                            <div class="d-flex align-items-center gap-2">
                                                <span
                                                    class="badge bg-success-soft text-success px-2 py-1 rounded-pill small fw-800">SYSTEM
                                                    NOMINAL</span>
                                                <small class="text-muted text-uppercase fw-bold letter-spacing-1"
                                                    style="font-size: 0.65rem;">Regional Grid Status</small>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-5">
                                            <div class="text-end">
                                                <span class="d-block text-muted text-uppercase fw-bold mb-1"
                                                    style="font-size: 0.65rem;">Operatives</span>
                                                <h3 class="mb-0 fw-800 text-primary" id="total-users-count">
                                                    <%= totalUsers %>
                                                </h3>
                                            </div>
                                            <div class="text-end border-start ps-5 border-light">
                                                <span class="d-block text-muted text-uppercase fw-bold mb-1"
                                                    style="font-size: 0.65rem;">Active Missions</span>
                                                <h3 class="mb-0 fw-800 text-danger" id="total-requests-count">
                                                    <a href="/disaster-reports"
                                                        class="text-danger text-decoration-none">
                                                        <%= totalRequests %>
                                                    </a>
                                                </h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Live Intelligence Grid -->
                            <div class="row g-4 mb-4">
                                <div class="col-lg-8">
                                    <div class="card p-0 border-0 shadow-sm h-100 overflow-hidden">
                                        <div
                                            class="p-3 border-bottom d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="bg-primary-soft p-2 rounded-md">
                                                    <i class="fa fa-crosshairs text-primary small"></i>
                                                </div>
                                                <h6 class="mb-0 fw-bold text-head text-uppercase small">Geospatial
                                                    Intelligence</h6>
                                            </div>
                                            <button class="btn btn-primary-soft btn-sm py-1 px-3 fw-bold small"
                                                onclick="refreshMapData();">
                                                <i class="fa fa-sync-alt me-1"></i>SYNC
                                            </button>
                                        </div>
                                        <div id="admin-map" style="height: 520px;"></div>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="card shadow-sm border-0 h-100 d-flex flex-column">
                                        <div
                                            class="p-3 border-bottom d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="bg-warning-soft p-2 rounded-md">
                                                    <i class="fa fa-bolt text-warning small"></i>
                                                </div>
                                                <h6 class="mb-0 fw-bold text-head text-uppercase small">Critical Risk
                                                    Alerts</h6>
                                            </div>
                                            <a href="/assessment-results"
                                                class="text-primary fw-bold small text-decoration-none">EXPLORE</a>
                                        </div>
                                        <div class="table-responsive flex-grow-1">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead>
                                                    <tr>
                                                        <th class="ps-4">Operative</th>
                                                        <th class="text-end pe-4">Risk Index</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% if (riskTables['High'] && riskTables['High'].length> 0) { %>
                                                        <% riskTables['High'].slice(0, 8).forEach(user=> { %>
                                                            <tr>
                                                                <td class="ps-4">
                                                                    <div class="d-flex align-items-center gap-2">
                                                                        <div class="avatar-xs bg-dark text-white rounded-circle d-flex align-items-center justify-content-center"
                                                                            style="width:24px; height:24px;">
                                                                            <i class="fa fa-user text-muted small"></i>
                                                                        </div>
                                                                        <span class="small fw-600">
                                                                            <%= user.username %>
                                                                        </span>
                                                                    </div>
                                                                </td>
                                                                <td class="text-end pe-4"><span
                                                                        class="badge bg-danger text-uppercase fw-800">
                                                                        <%= user.risk_score %>
                                                                    </span></td>
                                                            </tr>
                                                            <% }) %>
                                                                <% } else { %>
                                                                    <tr>
                                                                        <td colspan="2"
                                                                            class="text-center py-5 text-muted small">No
                                                                            critical alerts detected in sector</td>
                                                                    </tr>
                                                                    <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Analytics Row -->
                            <div class="row g-4 mb-4">
                                <div class="col-xl-6">
                                    <div class="card shadow-sm border-0 p-4">
                                        <div class="d-flex align-items-center gap-2 mb-4">
                                            <div class="bg-indigo-soft p-2 rounded-md">
                                                <i class="fa fa-chart-line text-indigo small"></i>
                                            </div>
                                            <h6 class="mb-0 fw-bold text-head text-uppercase small">Incident Trends</h6>
                                        </div>
                                        <canvas id="userChart" style="max-height: 280px;"></canvas>
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="card shadow-sm border-0 p-4">
                                        <div class="d-flex align-items-center gap-2 mb-4">
                                            <div class="bg-success-soft p-2 rounded-md">
                                                <i class="fa fa-chart-pie text-success small"></i>
                                            </div>
                                            <h6 class="mb-0 fw-bold text-head text-uppercase small">Risk Stratification
                                            </h6>
                                        </div>
                                        <div class="row align-items-center">
                                            <div class="col-md-7">
                                                <canvas id="riskLevelChart" style="max-height: 260px;"></canvas>
                                            </div>
                                            <div class="col-md-5">
                                                <div class="d-flex flex-column gap-3">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <span class="rounded-pill"
                                                            style="width: 12px; height: 12px; background: #1e293b;"></span>
                                                        <small class="text-muted fw-bold">Critical High</small>
                                                    </div>
                                                    <div class="d-flex align-items-center gap-2">
                                                        <span class="rounded-pill"
                                                            style="width: 12px; height: 12px; background: #475569;"></span>
                                                        <small class="text-muted fw-bold">Elevated Risk</small>
                                                    </div>
                                                    <div class="d-flex align-items-center gap-2">
                                                        <span class="rounded-pill"
                                                            style="width: 12px; height: 12px; background: #94a3b8;"></span>
                                                        <small class="text-muted fw-bold">Standard Risk</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Snapshots -->
                            <div class="row g-4">
                                <% [ { id: 'checklistChart' , icon: 'fa-tasks' , title: 'Operational Compliance' ,
                                    color: 'info' }, { id: 'trendChart' , icon: 'fa-history' ,
                                    title: 'Risk Accumulation' , color: 'secondary' }, { id: 'hazardsChart' ,
                                    icon: 'fa-biohazard' , title: 'Environmental Hazards' , color: 'danger' }
                                    ].forEach(widget=> { %>
                                    <div class="col-md-4">
                                        <div class="card shadow-sm border-0 p-4">
                                            <div class="d-flex align-items-center gap-2 mb-3">
                                                <div class="bg-<%= widget.color %>-soft p-2 rounded-md">
                                                    <i class="fa <%= widget.icon %> text-<%= widget.color %> small"></i>
                                                </div>
                                                <h6 class="mb-0 fw-bold text-head text-uppercase small"
                                                    style="font-size: 0.7rem;">
                                                    <%= widget.title %>
                                                </h6>
                                            </div>
                                            <canvas id="<%= widget.id %>" style="max-height: 180px;"></canvas>
                                        </div>
                                    </div>
                                    <% }) %>
                            </div>
                        </div>

                        <%- include('../partials/page-end'); %>
                        <%- include('../partials/footer'); %>
                </div>
    </div>

    <!-- Analytics & Map Scripts -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        (function ($) {
            "use strict";

            Chart.defaults.color = "#64748b";
            Chart.defaults.borderColor = "#f1f5f9";
            Chart.defaults.font.family = "'Inter', sans-serif";

            // --- Incident Trends ---
            new Chart($("#userChart").get(0).getContext("2d"), {
                type: "bar",
                data: {
                    labels: <% - JSON.stringify(chartData.map(d => d.day)) %>,
                    datasets: [{
                        label: "Incoming Reports",
                        data: <% - JSON.stringify(chartData.map(d => d.total)) %>,
                        backgroundColor: "#6366f1",
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [5, 5] } } }
                }
            });

            // --- Risk Stratification ---
            new Chart($("#riskLevelChart").get(0).getContext("2d"), {
                type: "doughnut",
                data: {
                    labels: <% - JSON.stringify(riskLevelData.map(d => d.risk_level)) %>,
                    datasets: [{
                        data: <% - JSON.stringify(riskLevelData.map(d => d.total)) %>,
                        backgroundColor: ["#1e293b", "#475569", "#94a3b8", "#cbd5e1"],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, cutout: '75%', plugins: { legend: { display: false } } }
            });

            // --- 其他图表保持一致逻辑 ---
            new Chart($("#checklistChart").get(0).getContext("2d"), {
                type: "bar",
                data: {
                    labels: ["River", "Fault", "Kit", "Plan"],
                    datasets: [{
                        data: [<%= checklistData.near_river %>, <%= checklistData.near_fault %>, <%= checklistData.has_emergency_kit %>, <%= checklistData.has_evacuation_plan %>],
                        backgroundColor: "#6366f1"
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            new Chart($("#trendChart").get(0).getContext("2d"), {
                type: "line",
                data: {
                    labels: <% - JSON.stringify(trendData.map(d => d.date)) %>,
                    datasets: [{
                        label: "Risk Velocity",
                        data: <% - JSON.stringify(trendData.map(d => d.avg_score)) %>,
                        borderColor: "#6366f1",
                        tension: 0.4,
                        fill: true,
                        backgroundColor: "rgba(99, 102, 241, 0.05)"
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
            });

            new Chart($("#hazardsChart").get(0).getContext("2d"), {
                type: "bar",
                data: {
                    labels: ["River", "Fault"],
                    datasets: [{
                        data: [<%= hazardsData.near_river %>, <%= hazardsData.near_fault %>],
                        backgroundColor: ["#ef4444", "#f59e0b"]
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

        })(jQuery);

        // --- Map Logic ---
        let adminMap, adminMarkersLayer, oms;
        let responders = [];
        let incidents = [];

        function initAdminMap() {
            adminMap = L.map('admin-map').setView([10.7202, 122.5621], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(adminMap);

            if (typeof OverlappingMarkerSpiderfier !== 'undefined') {
                oms = new OverlappingMarkerSpiderfier(adminMap, { keepSpiderfied: true, nearbyDistance: 20 });
            }
            adminMarkersLayer = L.layerGroup().addTo(adminMap);
            refreshMapData();
            setInterval(refreshMapData, 5000);
        }

        async function refreshMapData() {
            try {
                const [rR, rI, rS] = await Promise.all([fetch('/api/responders'), fetch('/api/incidents'), fetch('/api/admin/stats')]);
                responders = await rR.json();
                incidents = await rI.json();
                const stats = await rS.json();
                if (stats) {
                    $('#total-users-count').text(stats.totalUsers);
                    $('#total-requests-count').text(stats.totalRequests);
                }
                plotMap();
            } catch (e) { console.error(e); }
        }

        function plotMap() {
            adminMarkersLayer.clearLayers();
            if (oms) oms.clearMarkers();

            responders.forEach(r => {
                if (r.latitude && r.longitude && r.status !== 'offline') {
                    const color = r.status === 'active' ? '#10b981' : (r.status === 'deployed' ? '#f59e0b' : '#64748b');
                    const icon = L.divIcon({
                        className: 'responder-dot',
                        html: `<div style="background:${color}; width:12px; height:12px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 5px rgba(0,0,0,0.2);"></div>`,
                        iconSize: [12, 12]
                    });
                    L.marker([r.latitude, r.longitude], { icon }).addTo(adminMarkersLayer)
                        .bindPopup(`<strong>${r.firstname} ${r.lastname}</strong><br>Status: ${r.status.toUpperCase()}`);
                }
            });

            incidents.forEach(incident => {
                if ((incident.status === 'pending' || incident.status === 'responding') && incident.latitude && incident.longitude) {
                    const color = incident.disaster_type === 'Fire' ? '#ef4444' : (incident.disaster_type === 'Flood' ? '#3b82f6' : '#f97316');
                    const icon = L.divIcon({
                        className: 'incident-icon',
                        html: `<div style="background:${color}; width:24px; height:24px; border-radius:50%; border:2px solid #fff; display:flex; align-items:center; justify-content:center; color:#fff;"><i class="fa fa-triangle-exclamation" style="font-size:10px;"></i></div>`,
                        iconSize: [24, 24]
                    });
                    const marker = L.marker([incident.latitude, incident.longitude], { icon }).addTo(adminMarkersLayer);
                    marker.bindPopup(`<strong>${incident.disaster_type}</strong><br>Reported: ${new Date(incident.reported_at).toLocaleString()}<br><button class="btn btn-primary btn-sm w-100 mt-2" onclick="openDeployModal('${incident.id}', '${incident.disaster_type}', ${incident.latitude}, ${incident.longitude})">DEPLOY</button>`);
                    if (oms) oms.addMarker(marker);
                }
            });
        }

        window.openDeployModal = async function (reportId, type, lat, lng) {
            if (typeof window.openSharedDeployModal === 'function') {
                await window.openSharedDeployModal({ reportId, lat, lng, type, dateStr: new Date().toLocaleString() });
            }
        };

        if ($('#admin-map').length) initAdminMap();
        window.addEventListener('load', () => setTimeout(() => adminMap.invalidateSize(), 500));
    </script>
</body>

</html>