<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('../partials/head'); %>
</head>
<body>
  <div class="container-fluid position-relative d-flex p-0">
    <!-- Spinner Start -->
    <%- include('../partials/spinner'); %>
    <!-- Spinner End -->


    <!-- Sidebar Start -->
    <%- include('../partials/admin-sidebar'); %>
      <!-- Sidebar End -->


      <!-- Content Start -->
      <div class="content">
        <!-- Navbar Start -->
        <%- include('../partials/admin-navbar'); %>
          <!-- Navbar End -->

          <!-- Widgets Start -->
            <div class="container-fluid pt-4 px-4">
                <div class="row g-4">
                    <div class="col-12">
                        <div class="bg-secondary rounded h-100 p-4">
                            <h6 class="mb-4">Disaster Reports</h6>
                            <div class="table-responsive">
                                <table class="table table-hover text-nowrap">
                                    <thead>
                                        <tr>
                                            <th scope="col">Deploy / Status</th>
                                            <th scope="col">Sender</th>
                                            <th scope="col">Type</th>
                                            <th scope="col">Location</th>
                                            <th scope="col">Feedbacks</th>
                                            <th scope="col">Resolution</th>
                                            <th scope="col">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportsTableBody">
                                        <% reports.forEach(report => { %>
                                        <tr>
                                          <td>
                                              <% if (report.status === 'responding') { %>
                                                  <span class="badge bg-warning text-dark">Responding</span>
                                                  <button class="btn btn-sm btn-danger ms-1" onclick="cancelReportAdmin('<%= report.id %>')">Cancel</button>
                                              <% } else if (report.status === 'resolved') { %>
                                                  <span class="badge bg-success">Resolved</span>
                                              <% } else if (report.status === 'cancelled by user') { %>
                                                  <span class="badge bg-danger">Cancelled (User)</span>
                                              <% } else if (report.status === 'cancelled by admin') { %>
                                                  <span class="badge bg-danger">Cancelled (Admin)</span>
                                              <% } else if (report.status === 'cancelled') { %>
                                                  <span class="badge bg-danger">Cancelled</span>
                                              <% } else { %>
                                                  <div class="d-flex gap-2">
                                                      <button class="btn btn-sm btn-primary deploy-btn" 
                                                          data-id="<%= report.id %>" 
                                                          data-location="<%= report.location %>"
                                                          data-lat="<%= report.latitude %>"
                                                          data-lon="<%= report.longitude %>"
                                                          data-type="<%= report.disaster_type %>"
                                                          data-date="<%= new Date(report.reported_at).toLocaleString() %>"
                                                          onclick="initiateDeploy(this)">
                                                          Deploy
                                                      </button>
                                                      <button class="btn btn-sm btn-outline-danger" onclick="cancelReportAdmin('<%= report.id %>')">
                                                          Cancel
                                                      </button>
                                                  </div>
                                              <% } %>
                                          </td>
                                          <td>
                                              <%= report.sender %>
                                              <% if (report.responder_name) { %>
                                                  <span class="text-muted"> | Responder: <%= report.responder_name %></span>
                                              <% } %>
                                          </td>
                                          <td class="
                                                <% if (report.disaster_type === 'Fire') { %> bg-danger text-white 
                                                <% } else if (report.disaster_type === 'Flood') { %> bg-info text-dark 
                                                <% } else if (report.disaster_type === 'Earthquake') { %> bg-warning text-dark 
                                                <% } else if (report.disaster_type === 'Landslide') { %> bg-light text-white 
                                                <% } else { %> bg-light text-dark 
                                                <% } %>
                                                ">
                                                <%= report.disaster_type %>
                                            </td>

                                          <td>
                                            <span id="loc-display-<%= report.id %>">
                                                <%= report.latitude && report.longitude ? `(${report.latitude}, ${report.longitude})` : (report.location || "No Location") %>
                                            </span>
                                            <% if (report.latitude && report.longitude) { %>
                                                <br>
                                                <small>
                                                    <a href="#" class="text-primary" onclick="fetchFormattedAddress(this, <%= report.latitude %>, <%= report.longitude %>, 'loc-display-<%= report.id %>'); return false;">
                                                        Show Address
                                                    </a>
                                                </small>
                                            <% } %>
                                          </td>
                                          <td>
                                            <small>
                                                <strong><%= report.sender %>:</strong> "<%= report.user_message || 'Pending' %>" 
                                                <br>
                                                <% if(report.responder_name) { %>
                                                    <strong><%= report.responder_name %>:</strong> "<%= report.responder_message || 'Pending' %>"
                                                <% } else { %>
                                                    <strong>Responder:</strong> Pending
                                                <% } %>
                                            </small>
                                          </td>
                                          <td>
                                            <small>
                                                <% if (report.status === 'resolved') { %>
                                                    <% if (report.user_confirmed_at) { %>
                                                        <span class="text-success">User Resolved</span>
                                                    <% } %>
                                                    <% if (report.user_confirmed_at && report.responder_confirmed_at) { %> | <% } %>
                                                    <% if (report.responder_confirmed_at) { %>
                                                        <span class="text-primary">Responder Resolved</span>
                                                    <% } %>
                                                    <% if (!report.user_confirmed_at && !report.responder_confirmed_at) { %>
                                                        <%= report.resolution_remarks || 'Resolved' %>
                                                    <% } %>
                                                <% } else { %>
                                                    <span class="text-muted">Pending</span>
                                                <% } %>
                                            </small>
                                          </td>
                                          <td><%= new Date(report.reported_at).toLocaleString() %></td>

                                        </tr>
                                      <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          <!-- Widgets End -->     

          <!-- Footer Start -->
          <%- include('../partials/footer'); %>
            <!-- Footer End -->

      </div>
      <!-- Content End -->


      <!-- Back to Top -->
      <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
  </div>


    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/script.js"></script>
    
    <script>
        let deployMap = null;

        async function initiateDeploy(btn) {
            const reportId = btn.getAttribute('data-id');
            const storedLat = btn.getAttribute('data-lat');
            const storedLon = btn.getAttribute('data-lon');
            const reportType = btn.getAttribute('data-type') || 'General';
            const reportDate = btn.getAttribute('data-date') || 'N/A';
            let locationStr = btn.getAttribute('data-location');
            
             const cellSpan = document.getElementById(`loc-${reportId}`);
             if (cellSpan && cellSpan.innerText && !cellSpan.innerText.includes("Loading") && !cellSpan.innerText.includes("waiting")) {
                 locationStr = cellSpan.innerText;
             }
            
            let incLat = parseFloat(storedLat);
            let incLon = parseFloat(storedLon);

            if (isNaN(incLat) || isNaN(incLon)) {
                if (locationStr && locationStr !== 'Usage Location') {
                    try {
                        Swal.fire({ title: 'Resolving Location...', didOpen: () => Swal.showLoading() });
                        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationStr)}`;
                        const res = await fetch(url);
                        const geoData = await res.json();
                         if (geoData && geoData.length > 0) {
                            incLat = parseFloat(geoData[0].lat);
                            incLon = parseFloat(geoData[0].lon);
                         }
                         Swal.close();
                    } catch(e) { 
                        console.error(e); 
                        Swal.close();
                    }
                }
            }

            if (!incLat || !incLon) {
                Swal.fire('Error', 'Cannot deploy: Location coordinates missing.', 'error');
                return;
            }

            window.openSharedDeployModal({
                reportId, 
                lat: incLat, 
                lng: incLon, 
                type: reportType, 
                dateStr: reportDate, 
                locationStr
            });
        }
        function cancelReportAdmin(id) {
            Swal.fire({
                title: 'Confirm Admin Cancellation',
                text: "Are you sure you want to cancel this SOS report as an administrator?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, cancel it'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/api/admin/cancel_report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: id })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Cancelled', 'The report has been cancelled by admin.', 'success')
                            .then(() => location.reload());
                        } else {
                            Swal.fire('Error', 'Failed to cancel report.', 'error');
                        }
                    });
                }
            });
        }
    </script>

    <script>
        // Lazy load address function
        async function fetchFormattedAddress(linkEl, lat, lon, targetId) {
            const targetEl = document.getElementById(targetId);
            if(!targetEl) return;

            // Change link to loading
            linkEl.innerText = "Loading...";
            linkEl.style.pointerEvents = "none";
            linkEl.style.color = "grey";

            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                const data = await res.json();
                if (data.display_name) {
                    targetEl.innerText = data.display_name;
                    linkEl.style.display = 'none'; // Hide the button after success
                } else {
                    targetEl.innerText = `(${lat}, ${lon}) - Unknown Address`;
                    linkEl.innerText = "Retry";
                    linkEl.style.pointerEvents = "auto";
                }
            } catch (e) {
                console.error(e);
                linkEl.innerText = "Failed. Retry?";
                linkEl.style.pointerEvents = "auto";
                linkEl.style.color = "red";
            }
        }

        // Real-time Polling
        let previousReportsJSON = '';
        setInterval(() => {
            fetch('/api/incidents?t=' + Date.now())
            .then(res => res.json())
            .then(data => {
                const currentJSON = JSON.stringify(data);
                if(currentJSON === previousReportsJSON) return;
                previousReportsJSON = currentJSON;
                
                const tbody = document.getElementById('reportsTableBody');
                let html = '';
                
                data.forEach(report => {
                    let actionHtml = '';
                    if (report.status === 'responding') {
                        actionHtml = `<span class="badge bg-warning text-dark">Responding</span>
                                      <button class="btn btn-sm btn-danger ms-1" onclick="cancelReportAdmin('${report.id}')">Cancel</button>`;
                    } else if (report.status === 'resolved') {
                        actionHtml = `<span class="badge bg-success">Resolved</span>`;
                    } else if (report.status === 'cancelled by user') {
                        actionHtml = `<span class="badge bg-danger">Cancelled (User)</span>`;
                    } else if (report.status === 'cancelled by admin') {
                        actionHtml = `<span class="badge bg-danger">Cancelled (Admin)</span>`;
                    } else if (report.status === 'cancelled') {
                        actionHtml = `<span class="badge bg-danger">Cancelled</span>`;
                    } else {
                        actionHtml = `
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary deploy-btn" 
                                    data-id="${report.id}" 
                                    data-location="${report.location || ''}"
                                    data-lat="${report.latitude}"
                                    data-lon="${report.longitude}"
                                    data-type="${report.disaster_type}"
                                    data-date="${new Date(report.time).toLocaleString()}"
                                    onclick="initiateDeploy(this)">
                                    Deploy
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="cancelReportAdmin('${report.id}')">
                                    Cancel
                                </button>
                            </div>
                        `;
                    }

                    // Sender
                    const sender = report.sender || (report.user_id ? 'User ' + report.user_id : 'Unknown');

                    // Type Class
                    let typeClass = 'bg-light text-dark';
                    if (report.disaster_type === 'Fire') typeClass = 'bg-danger text-white';
                    else if (report.disaster_type === 'Flood') typeClass = 'bg-info text-dark';
                    else if (report.disaster_type === 'Earthquake') typeClass = 'bg-warning text-dark';
                    else if (report.disaster_type === 'Landslide') typeClass = 'bg-light text-white';

                    // Location Logic
                    let locHtml = `<span id="loc-display-${report.id}">
                        ${report.latitude && report.longitude ? `(${report.latitude}, ${report.longitude})` : (report.location || "No Location")}
                    </span>`;
                    
                    if (report.latitude && report.longitude) {
                        locHtml += `<br><small>
                            <a href="#" class="text-primary" onclick="fetchFormattedAddress(this, ${report.latitude}, ${report.longitude}, 'loc-display-${report.id}'); return false;">Show Address</a>
                        </small>`;
                    }
                    
                    // Resolution Logic
                    let resolutionContent = '<span class="text-muted">Pending</span>';
                    if (report.status === 'resolved') {
                        let parts = [];
                        if (report.user_confirmed_at) parts.push('<span class="text-success">User Resolved</span>');
                        if (report.responder_confirmed_at) parts.push('<span class="text-primary">Responder Resolved</span>');
                        
                        if (parts.length > 0) {
                            resolutionContent = parts.join(' | ');
                        } else {
                            resolutionContent = report.resolution_remarks || 'Resolved';
                        }
                    }

                    // Feedbacks Logic
                    const responderName = report.responder_name ? report.responder_name : 'Pending';
                    const feedbackContent = `
                        <strong>${report.sender}:</strong> "${report.user_message || 'Pending'}"<br>
                        <strong>${report.responder_name ? report.responder_name : 'Responder'}:</strong> "${report.responder_message || 'Pending'}"
                    `;

                    html += `
                        <tr>
                            <td>${actionHtml}</td>
                            <td>${sender}${report.responder_name ? ' <span class="text-muted">| Responder: ' + report.responder_name + '</span>' : ''}</td>
                            <td class="${typeClass}">${report.disaster_type}</td>
                            <td>${locHtml}</td>
                            <td><small>${feedbackContent}</small></td>
                            <td><small>${resolutionContent}</small></td>
                            <td>${new Date(report.time).toLocaleString()}</td>
                        </tr>
                    `;
                });
                
                if(tbody) tbody.innerHTML = html;
            })
            .catch(e => console.error("Polling error:", e));
        }, 1000);
    </script>
</body>
</html>
