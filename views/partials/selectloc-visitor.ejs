<div class="selectloc-container shadow-sm rounded overflow-hidden bg-white border-light mt-4">
    <div class="p-3 bg-dark text-white border-bottom d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-2">
            <i class="fa fa-location-crosshairs text-primary"></i>
            <h6 id="address-visitor" class="mb-0 small fw-bold text-head text-truncate" style="max-width: 200px;">Public
                Geolocation...</h6>
        </div>
        <button type="button" onclick="refreshVisitorLocation()"
            class="btn btn-primary-soft btn-xs px-2 py-1 small fw-800">
            <i class="fa fa-sync-alt me-1"></i>RE-SYNC
        </button>
    </div>

    <div id="selectloc-visitor-map" style="height: 300px; width: 100%;"></div>

    <div class="p-2 px-3 bg-dark text-white border-top d-flex align-items-center justify-content-between">
        <code id="coords-visitor" class="small text-muted" style="font-size: 0.65rem;">Scanning grid...</code>
        <div class="d-flex align-items-center gap-1">
            <span class="badge bg-success-soft text-success p-1 rounded-circle" style="width: 6px; height: 6px;"></span>
            <small class="text-muted" style="font-size: 0.6rem;">Public Feed</small>
        </div>
    </div>
</div>

<script>
    (function () {
        var vMap = L.map('selectloc-visitor-map').setView([10.7202, 122.5621], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vMap);

        let vMarker = null;

        window.refreshVisitorLocation = function () {
            document.getElementById('address-visitor').innerHTML = `<i class="opacity-50">Polling Satellites...</i>`;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const latlng = L.latLng(lat, lng);

                    if (vMarker) {
                        vMarker.setLatLng(latlng);
                    } else {
                        vMarker = L.marker(latlng).addTo(vMap).bindPopup("You are here (Visitor View)").openPopup();
                    }

                    vMap.setView(latlng, 15);
                    document.getElementById("coords-visitor").innerText = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

                    fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('address-visitor').innerText = data.display_name;
                            if (typeof showMap === 'function') {
                                showMap({ coords: { latitude: lat, longitude: lng } });
                            }
                        });
                }, err => {
                    document.getElementById('address-visitor').innerText = "Location Denied";
                });
            }
        };

        refreshVisitorLocation();
    })();
</script>