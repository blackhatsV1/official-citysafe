<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />



<script>
    var map = L.map('map').fitWorld();

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    function onLocationFound(e) {
        var radius = e.accuracy;
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;
        // Format to 6 decimal places
        var coords = "Latitude: " + lat.toFixed(6) + ", " + "Longitude: " + lng.toFixed(6);

        L.marker(e.latlng).addTo(map)
            .bindPopup("You are within " + radius.toFixed(1) + " meters from this point").openPopup();
        L.circle(e.latlng, radius).addTo(map);

        document.getElementById("coords").textContent = coords;

        if (typeof showMap === 'function') {
            try {
                showMap({ coords: { latitude: lat, longitude: lng } });
            } catch (err) { console.error("Weather Map Error:", err); }
        }

        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.address) {
                    const addr = data.address;
                    let poi = addr.amenity || addr.building || addr.office || addr.shop || addr.neighbourhood;
                    let street = addr.road;
                    let house = addr.house_number;

                    let finalAddress = "";
                    if (poi && street) {
                        finalAddress = `${poi}, ${street}`;
                    } else if (house && street) {
                        finalAddress = `${house} ${street}`;
                    } else {
                        finalAddress = poi || street || data.display_name.split(',')[0] || "Unknown Location";
                    }

                    document.getElementById('address').innerHTML = `Location: <b>${finalAddress}</b>`;
                } else {
                    document.getElementById('address').innerHTML = `Location: <b>${data.display_name || "Unknown"}</b>`;
                }
            })
            .catch(err => {
                console.error("Address Error:", err);
                document.getElementById('address').innerText = `Unmarked Area (${lat.toFixed(6)}, ${lng.toFixed(6)})`;
            });
    }

    function onLocationError(e) {
        console.warn("Leaflet Geolocation Error:", e.message);
        // Fallback to manual navigator.geolocation if Leaflet's map.locate fails
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map.setView(latlng, 16);
                    onLocationFound({ latlng: latlng, accuracy: pos.coords.accuracy });
                },
                (err) => {
                    let msg = "Unable to retrieve location.";
                    if (err.code === 1) msg = "Location permission denied. Please enable location in browser settings.";
                    else if (err.code === 2) msg = "Location unavailable.";
                    else if (err.code === 3) msg = "Location request timed out.";

                    alert(msg);
                },
                { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
            );
        } else {
            alert(e.message);
        }
    }

    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    // Reliable start
    if (!window.isSecureContext) {
        console.warn("Not in a secure context. Geolocation may fail in Chrome.");
    }

    map.locate({
        setView: true,
        maxZoom: 16,
        enableHighAccuracy: true, // Better for Chrome & mobile reliability
        timeout: 30000,
        maximumAge: 0 // Cache for 1 min
    });
</script>